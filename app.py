import streamlit as st
import pandas as pd
import io
import qrcode
import base64
import zipfile
from urllib.parse import urlencode
from PIL import Image, ImageDraw, ImageFont
import requests

# ================================
# 應用程式標題與頁面設定
# ================================
st.set_page_config(page_title="社區區權會投票")
st.title("社區區權會多議題投票應用程式")

# 設定您的應用程式公開網址
# 如果您重新部署或網址變動，請務必更新此處
APP_URL = "https://acidcocco.onrender.com"

# GitHub 專案的 CSV 檔案網址
VOTE_URL_PREFIX = "https://raw.githubusercontent.com/acidcocco/community-voting-app/main/vote_results_"

# ================================
# 議題清單
# ================================
ISSUES = [
    "議題一：是否同意實施社區公設改善工程？",
    "議題二：是否同意調整社區管理費？",
    "議題三：是否同意續聘現有物業管理公司？"
]

# 內嵌名冊資料
RAW_DATA = [
    {"戶號": "C1-3F", "區分比例": 0.3227},
    {"戶號": "C1-4F", "區分比例": 0.3227},
    {"戶號": "C1-5F", "區分比例": 0.3227},
    {"戶號": "C1-6F", "區分比例": 0.3227},
    {"戶號": "C1-7F", "區分比例": 0.3227},
    {"戶號": "C1-8F", "區分比例": 0.3227},
    {"戶號": "C1-9F", "區分比例": 0.3227},
    {"戶號": "C1-10F", "區分比例": 0.3227},
    {"戶號": "C1-11F", "區分比例": 0.3227},
    {"戶號": "C1-12F", "區分比例": 0.3227},
    {"戶號": "C1-13F", "區分比例": 0.3227},
    {"戶號": "C1-14F", "區分比例": 0.3581},
    {"戶號": "C2-3F", "區分比例": 0.3227},
    {"戶號": "C2-4F", "區分比例": 0.3227},
    {"戶號": "C2-5F", "區分比例": 0.3227},
    {"戶號": "C2-6F", "區分比例": 0.3227},
    {"戶號": "C2-7F", "區分比例": 0.3227},
    {"戶號": "C2-8F", "區分比例": 0.3227},
    {"戶號": "C2-9F", "區分比例": 0.3227},
    {"戶號": "C2-10F", "區分比例": 0.3227},
    {"戶號": "C2-11F", "區分比例": 0.3227},
    {"戶號": "C2-12F", "區分比例": 0.3227},
    {"戶號": "C2-13F", "區分比例": 0.3227},
    {"戶號": "C2-14F", "區分比例": 0.3581},
    {"戶號": "B5-2F", "區分比例": 0.2596},
    {"戶號": "B5-3F", "區分比例": 0.2587},
    {"戶號": "B5-4F", "區分比例": 0.2587},
    {"戶號": "B5-5F", "區分比例": 0.2587},
    {"戶號": "B5-6F", "區分比例": 0.2587},
    {"戶號": "B5-7F", "區分比例": 0.2587},
    {"戶號": "B5-8F", "區分比例": 0.2587},
    {"戶號": "B5-9F", "區分比例": 0.2587},
    {"戶號": "B5-10F", "區分比例": 0.2587},
    {"戶號": "B5-11F", "區分比例": 0.2587},
    {"戶號": "B5-12F", "區分比例": 0.2587},
    {"戶號": "B5-13F", "區分比例": 0.2587},
    {"戶號": "B3-2F", "區分比例": 0.2538},
    {"戶號": "B3-3F", "區分比例": 0.2538},
    {"戶號": "B3-4F", "區分比例": 0.2538},
    {"戶號": "B3-5F", "區分比例": 0.2538},
    {"戶號": "B3-6F", "區分比例": 0.2538},
    {"戶號": "B3-7F", "區分比例": 0.2538},
    {"戶號": "B3-8F", "區分比例": 0.2538},
    {"戶號": "B3-9F", "區分比例": 0.2538},
    {"戶號": "B3-10F", "區分比例": 0.2538},
    {"戶號": "B3-11F", "區分比例": 0.2538},
    {"戶號": "B3-12F", "區分比例": 0.2538},
    {"戶號": "B3-13F", "區分比例": 0.2538},
    {"戶號": "B1-2F", "區分比例": 0.246},
    {"戶號": "B1-3F", "區分比例": 0.2464},
    {"戶號": "B1-4F", "區分比例": 0.2464},
    {"戶號": "B1-5F", "區分比例": 0.2464},
    {"戶號": "B1-6F", "區分比例": 0.2464},
    {"戶號": "B1-7F", "區分比例": 0.2464},
    {"戶號": "B1-8F", "區分比例": 0.2464},
    {"戶號": "B1-9F", "區分比例": 0.2464},
    {"戶號": "B1-10F", "區分比例": 0.2464},
    {"戶號": "B1-11F", "區分比例": 0.2464},
    {"戶號": "B1-12F", "區分比例": 0.2464},
    {"戶號": "B1-13F", "區分比例": 0.2464},
    {"戶號": "B2-2F", "區分比例": 0.2496},
    {"戶號": "B2-3F", "區分比例": 0.2498},
    {"戶號": "B2-4F", "區分比例": 0.2498},
    {"戶號": "B2-5F", "區分比例": 0.2498},
    {"戶號": "B2-6F", "區分比例": 0.2498},
    {"戶號": "B2-7F", "區分比例": 0.2498},
    {"戶號": "B2-8F", "區分比例": 0.2498},
    {"戶號": "B2-9F", "區分比例": 0.2498},
    {"戶號": "B2-10F", "區分比例": 0.2498},
    {"戶號": "B2-11F", "區分比例": 0.2498},
    {"戶號": "B2-12F", "區分比例": 0.2498},
    {"戶號": "B2-13F", "區分比例": 0.2498},
    {"戶號": "A5-2F", "區分比例": 0.2527},
    {"戶號": "A5-3F", "區分比例": 0.2529},
    {"戶號": "A5-4F", "區分比例": 0.2529},
    {"戶號": "A5-5F", "區分比例": 0.2529},
    {"戶號": "A5-6F", "區分比例": 0.2529},
    {"戶號": "A5-7F", "區分比例": 0.2529},
    {"戶號": "A5-8F", "區分比例": 0.2529},
    {"戶號": "A5-9F", "區分比例": 0.2529},
    {"戶號": "A5-10F", "區分比例": 0.2529},
    {"戶號": "A5-11F", "區分比例": 0.2529},
    {"戶號": "A5-12F", "區分比例": 0.2529},
    {"戶號": "A5-13F", "區分比例": 0.2529},
    {"戶號": "A3-2F", "區分比例": 0.2491},
    {"戶號": "A3-3F", "區分比例": 0.2493},
    {"戶號": "A3-4F", "區分比例": 0.2493},
    {"戶號": "A3-5F", "區分比例": 0.2493},
    {"戶號": "A3-6F", "區分比例": 0.2493},
    {"戶號": "A3-7F", "區分比例": 0.2493},
    {"戶號": "A3-8F", "區分比例": 0.2493},
    {"戶號": "A3-9F", "區分比例": 0.2493},
    {"戶號": "A3-10F", "區分比例": 0.2493},
    {"戶號": "A3-11F", "區分比例": 0.2493},
    {"戶號": "A3-12F", "區分比例": 0.2493},
    {"戶號": "A3-13F", "區分比例": 0.2493},
    {"戶號": "A2-2F", "區分比例": 0.3046},
    {"戶號": "A2-3F", "區分比例": 0.2532},
    {"戶號": "A2-4F", "區分比例": 0.2532},
    {"戶號": "A2-5F", "區分比例": 0.2532},
    {"戶號": "A2-6F", "區分比例": 0.2532},
    {"戶號": "A2-7F", "區分比例": 0.2532},
    {"戶號": "A2-8F", "區分比例": 0.2532},
    {"戶號": "A2-9F", "區分比例": 0.2532},
    {"戶號": "A2-10F", "區分比例": 0.2532},
    {"戶號": "A2-11F", "區分比例": 0.2532},
    {"戶號": "A2-12F", "區分比例": 0.2532},
    {"戶號": "A2-13F", "區分比例": 0.2532},
    {"戶號": "A1-3F", "區分比例": 0.2534},
    {"戶號": "A1-4F", "區分比例": 0.2534},
    {"戶號": "A1-5F", "區分比例": 0.2534},
    {"戶號": "A1-6F", "區分比例": 0.2534},
    {"戶號": "A1-7F", "區分比例": 0.2534},
    {"戶號": "A1-8F", "區分比例": 0.2534},
    {"戶號": "A1-9F", "區分比例": 0.2534},
    {"戶號": "A1-10F", "區分比例": 0.2534},
    {"戶號": "A1-11F", "區分比例": 0.2534},
    {"戶號": "A1-12F", "區分比例": 0.2534},
    {"戶號": "A1-13F", "區分比例": 0.2534},
    {"戶號": "J3-3F", "區分比例": 0.2575},
    {"戶號": "J3-4F", "區分比例": 0.2575},
    {"戶號": "J3-5F", "區分比例": 0.2575},
    {"戶號": "J3-6F", "區分比例": 0.2575},
    {"戶號": "J3-7F", "區分比例": 0.2575},
    {"戶號": "J3-8F", "區分比例": 0.2575},
    {"戶號": "J3-9F", "區分比例": 0.2575},
    {"戶號": "J3-10F", "區分比例": 0.2575},
    {"戶號": "J3-11F", "區分比例": 0.2575},
    {"戶號": "J3-12F", "區分比例": 0.2575},
    {"戶號": "J3-13F", "區分比例": 0.2575},
    {"戶號": "J2-2F", "區分比例": 0.2717},
    {"戶號": "J2-3F", "區分比例": 0.2528},
    {"戶號": "J2-4F", "區分比例": 0.2528},
    {"戶號": "J2-5F", "區分比例": 0.2528},
    {"戶號": "J2-6F", "區分比例": 0.2528},
    {"戶號": "J2-7F", "區分比例": 0.2528},
    {"戶號": "J2-8F", "區分比例": 0.2528},
    {"戶號": "J2-9F", "區分比例": 0.2528},
    {"戶號": "J2-10F", "區分比例": 0.2528},
    {"戶號": "J2-11F", "區分比例": 0.2528},
    {"戶號": "J2-12F", "區分比例": 0.2528},
    {"戶號": "J2-13F", "區分比例": 0.2528},
    {"戶號": "J1-2F", "區分比例": 0.252},
    {"戶號": "J1-3F", "區分比例": 0.2522},
    {"戶號": "J1-4F", "區分比例": 0.2522},
    {"戶號": "J1-5F", "區分比例": 0.2522},
    {"戶號": "J1-6F", "區分比例": 0.2522},
    {"戶號": "J1-7F", "區分比例": 0.2522},
    {"戶號": "J1-8F", "區分比例": 0.2522},
    {"戶號": "J1-9F", "區分比例": 0.2522},
    {"戶號": "J1-10F", "區分比例": 0.2522},
    {"戶號": "J1-11F", "區分比例": 0.2522},
    {"戶號": "J1-12F", "區分比例": 0.2522},
    {"戶號": "J1-13F", "區分比例": 0.2522},
    {"戶號": "I2-2F", "區分比例": 0.2563},
    {"戶號": "I2-3F", "區分比例": 0.2563},
    {"戶號": "I2-4F", "區分比例": 0.2563},
    {"戶號": "I2-5F", "區分比例": 0.2563},
    {"戶號": "I2-6F", "區分比例": 0.2563},
    {"戶號": "I2-7F", "區分比例": 0.2563},
    {"戶號": "I2-8F", "區分比例": 0.2563},
    {"戶號": "I2-9F", "區分比例": 0.2563},
    {"戶號": "I2-10F", "區分比例": 0.2563},
    {"戶號": "I2-11F", "區分比例": 0.2563},
    {"戶號": "I2-12F", "區分比例": 0.2563},
    {"戶號": "I2-13F", "區分比例": 0.2563},
    {"戶號": "I1-2F", "區分比例": 0.2559},
    {"戶號": "I1-3F", "區分比例": 0.2559},
    {"戶號": "I1-4F", "區分比例": 0.2559},
    {"戶號": "I1-5F", "區分比例": 0.2559},
    {"戶號": "I1-6F", "區分比例": 0.2559},
    {"戶號": "I1-7F", "區分比例": 0.2559},
    {"戶號": "I1-8F", "區分比例": 0.2559},
    {"戶號": "I1-9F", "區分比例": 0.2559},
    {"戶號": "I1-10F", "區分比例": 0.2559},
    {"戶號": "I1-11F", "區分比例": 0.2559},
    {"戶號": "I1-12F", "區分比例": 0.2559},
    {"戶號": "I1-13F", "區分比例": 0.2559},
    {"戶號": "H2-2F", "區分比例": 0.3072},
    {"戶號": "H2-3F", "區分比例": 0.3072},
    {"戶號": "H2-4F", "區分比例": 0.3072},
    {"戶號": "H2-5F", "區分比例": 0.3072},
    {"戶號": "H2-6F", "區分比例": 0.3072},
    {"戶號": "H2-7F", "區分比例": 0.3072},
    {"戶號": "H2-8F", "區分比例": 0.3072},
    {"戶號": "H2-9F", "區分比例": 0.3072},
    {"戶號": "H2-10F", "區分比例": 0.3072},
    {"戶號": "H2-11F", "區分比例": 0.3072},
    {"戶號": "H2-12F", "區分比例": 0.3072},
    {"戶號": "H2-13F", "區分比例": 0.3072},
    {"戶號": "H2-14F", "區分比例": 0.3503},
    {"戶號": "H1-2F", "區分比例": 0.3072},
    {"戶號": "H1-3F", "區分比例": 0.3072},
    {"戶號": "H1-4F", "區分比例": 0.3072},
    {"戶號": "H1-5F", "區分比例": 0.3072},
    {"戶號": "H1-6F", "區分比例": 0.3072},
    {"戶號": "H1-7F", "區分比例": 0.3072},
    {"戶號": "H1-8F", "區分比例": 0.3072},
    {"戶號": "H1-9F", "區分比例": 0.3072},
    {"戶號": "H1-10F", "區分比例": 0.3072},
    {"戶號": "H1-11F", "區分比例": 0.3072},
    {"戶號": "H1-12F", "區分比例": 0.3072},
    {"戶號": "H1-13F", "區分比例": 0.3072},
    {"戶號": "H1-14F", "區分比例": 0.3503},
    {"戶號": "G2-2F", "區分比例": 0.2551},
    {"戶號": "G2-3F", "區分比例": 0.2551},
    {"戶號": "G2-4F", "區分比例": 0.2551},
    {"戶號": "G2-5F", "區分比例": 0.2551},
    {"戶號": "G2-6F", "區分比例": 0.2551},
    {"戶號": "G2-7F", "區分比例": 0.2551},
    {"戶號": "G2-8F", "區分比例": 0.2551},
    {"戶號": "G2-9F", "區分比例": 0.2551},
    {"戶號": "G2-10F", "區分比例": 0.2551},
    {"戶號": "G2-11F", "區分比例": 0.2551},
    {"戶號": "G2-12F", "區分比例": 0.2551},
    {"戶號": "G2-13F", "區分比例": 0.2551},
    {"戶號": "G1-2F", "區分比例": 0.2556},
    {"戶號": "G1-3F", "區分比例": 0.2586},
    {"戶號": "G1-4F", "區分比例": 0.2586},
    {"戶號": "G1-5F", "區分比例": 0.2586},
    {"戶號": "G1-6F", "區分比例": 0.2586},
    {"戶號": "G1-7F", "區分比例": 0.2586},
    {"戶號": "G1-8F", "區分比例": 0.2586},
    {"戶號": "G1-9F", "區分比例": 0.2586},
    {"戶號": "G1-10F", "區分比例": 0.2586},
    {"戶號": "G1-11F", "區分比例": 0.2586},
    {"戶號": "G1-12F", "區分比例": 0.2586},
    {"戶號": "G1-13F", "區分比例": 0.2586},
    {"戶號": "F3-2F", "區分比例": 0.25},
    {"戶號": "F3-3F", "區分比例": 0.2503},
    {"戶號": "F3-4F", "區分比例": 0.2503},
    {"戶號": "F3-5F", "區分比例": 0.2503},
    {"戶號": "F3-6F", "區分比例": 0.2503},
    {"戶號": "F3-7F", "區分比例": 0.2503},
    {"戶號": "F3-8F", "區分比例": 0.2503},
    {"戶號": "F3-9F", "區分比例": 0.2503},
    {"戶號": "F3-10F", "區分比例": 0.2503},
    {"戶號": "F3-11F", "區分比例": 0.2503},
    {"戶號": "F3-12F", "區分比例": 0.2503},
    {"戶號": "F3-13F", "區分比例": 0.2503},
    {"戶號": "F2-2F", "區分比例": 0.2705},
    {"戶號": "F2-3F", "區分比例": 0.2518},
    {"戶號": "F2-4F", "區分比例": 0.2518},
    {"戶號": "F2-5F", "區分比例": 0.2518},
    {"戶號": "F2-6F", "區分比例": 0.2518},
    {"戶號": "F2-7F", "區分比例": 0.2518},
    {"戶號": "F2-8F", "區分比例": 0.2518},
    {"戶號": "F2-9F", "區分比例": 0.2518},
    {"戶號": "F2-10F", "區分比例": 0.2518},
    {"戶號": "F2-11F", "區分比例": 0.2518},
    {"戶號": "F2-12F", "區分比例": 0.2518},
    {"戶號": "F2-13F", "區分比例": 0.2518},
    {"戶號": "F1-3F", "區分比例": 0.2564},
    {"戶號": "F1-4F", "區分比例": 0.2564},
    {"戶號": "F1-5F", "區分比例": 0.2564},
    {"戶號": "F1-6F", "區分比例": 0.2564},
    {"戶號": "F1-7F", "區分比例": 0.2564},
    {"戶號": "F1-8F", "區分比例": 0.2564},
    {"戶號": "F1-9F", "區分比例": 0.2564},
    {"戶號": "F1-10F", "區分比例": 0.2564},
    {"戶號": "F1-11F", "區分比例": 0.2564},
    {"戶號": "F1-12F", "區分比例": 0.2564},
    {"戶號": "F1-13F", "區分比例": 0.2564},
    {"戶號": "E5-3F", "區分比例": 0.2534},
    {"戶號": "E5-4F", "區分比例": 0.2534},
    {"戶號": "E5-5F", "區分比例": 0.2534},
    {"戶號": "E5-6F", "區分比例": 0.2534},
    {"戶號": "E5-7F", "區分比例": 0.2534},
    {"戶號": "E5-8F", "區分比例": 0.2534},
    {"戶號": "E5-9F", "區分比例": 0.2534},
    {"戶號": "E5-10F", "區分比例": 0.2534},
    {"戶號": "E5-11F", "區分比例": 0.2534},
    {"戶號": "E5-12F", "區分比例": 0.2534},
    {"戶號": "E5-13F", "區分比例": 0.2534},
    {"戶號": "E3-2F", "區分比例": 0.3049},
    {"戶號": "E3-3F", "區分比例": 0.2532},
    {"戶號": "E3-4F", "區分比例": 0.2532},
    {"戶號": "E3-5F", "區分比例": 0.2532},
    {"戶號": "E3-6F", "區分比例": 0.2532},
    {"戶號": "E3-7F", "區分比例": 0.2532},
    {"戶號": "E3-8F", "區分比例": 0.2532},
    {"戶號": "E3-9F", "區分比例": 0.2532},
    {"戶號": "E3-10F", "區分比例": 0.2532},
    {"戶號": "E3-11F", "區分比例": 0.2532},
    {"戶號": "E3-12F", "區分比例": 0.2532},
    {"戶號": "E3-13F", "區分比例": 0.2532},
    {"戶號": "E2-2F", "區分比例": 0.249},
    {"戶號": "E2-3F", "區分比例": 0.2492},
    {"戶號": "E2-4F", "區分比例": 0.2492},
    {"戶號": "E2-5F", "區分比例": 0.2492},
    {"戶號": "E2-6F", "區分比例": 0.2492},
    {"戶號": "E2-7F", "區分比例": 0.2492},
    {"戶號": "E2-8F", "區分比例": 0.2492},
    {"戶號": "E2-9F", "區分比例": 0.2492},
    {"戶號": "E2-10F", "區分比例": 0.2492},
    {"戶號": "E2-11F", "區分比例": 0.2492},
    {"戶號": "E2-12F", "區分比例": 0.2492},
    {"戶號": "E2-13F", "區分比例": 0.2492},
    {"戶號": "E1-2F", "區分比例": 0.2527},
    {"戶號": "E1-3F", "區分比例": 0.2529},
    {"戶號": "E1-4F", "區分比例": 0.2529},
    {"戶號": "E1-5F", "區分比例": 0.2529},
    {"戶號": "E1-6F", "區分比例": 0.2529},
    {"戶號": "E1-7F", "區分比例": 0.2529},
    {"戶號": "E1-8F", "區分比例": 0.2529},
    {"戶號": "E1-9F", "區分比例": 0.2529},
    {"戶號": "E1-10F", "區分比例": 0.2529},
    {"戶號": "E1-11F", "區分比例": 0.2529},
    {"戶號": "E1-12F", "區分比例": 0.2529},
    {"戶號": "E1-13F", "區分比例": 0.2529},
    {"戶號": "D5-2F", "區分比例": 0.2529},
    {"戶號": "D5-3F", "區分比例": 0.2496},
    {"戶號": "D5-4F", "區分比例": 0.2498},
    {"戶號": "D5-5F", "區分比例": 0.2498},
    {"戶號": "D5-6F", "區分比例": 0.2498},
    {"戶號": "D5-7F", "區分比例": 0.2498},
    {"戶號": "D5-8F", "區分比例": 0.2498},
    {"戶號": "D5-9F", "區分比例": 0.2498},
    {"戶號": "D5-10F", "區分比例": 0.2498},
    {"戶號": "D5-11F", "區分比例": 0.2498},
    {"戶號": "D5-12F", "區分比例": 0.2498},
    {"戶號": "D5-13F", "區分比例": 0.2498},
    {"戶號": "D3-2F", "區分比例": 0.2498},
    {"戶號": "D3-3F", "區分比例": 0.2459},
    {"戶號": "D3-4F", "區分比例": 0.2463},
    {"戶號": "D3-5F", "區分比例": 0.2463},
    {"戶號": "D3-6F", "區分比例": 0.2463},
    {"戶號": "D3-7F", "區分比例": 0.2463},
    {"戶號": "D3-8F", "區分比例": 0.2463},
    {"戶號": "D3-9F", "區分比例": 0.2463},
    {"戶號": "D3-10F", "區分比例": 0.2463},
    {"戶號": "D3-11F", "區分比例": 0.2463},
    {"戶號": "D3-12F", "區分比例": 0.2463},
    {"戶號": "D3-13F", "區分比例": 0.2463},
    {"戶號": "D2-2F", "區分比例": 0.2463},
    {"戶號": "D2-3F", "區分比例": 0.2538},
    {"戶號": "D2-4F", "區分比例": 0.2538},
    {"戶號": "D2-5F", "區分比例": 0.2538},
    {"戶號": "D2-6F", "區分比例": 0.2538},
    {"戶號": "D2-7F", "區分比例": 0.2538},
    {"戶號": "D2-8F", "區分比例": 0.2538},
    {"戶號": "D2-9F", "區分比例": 0.2538},
    {"戶號": "D2-10F", "區分比例": 0.2538},
    {"戶號": "D2-11F", "區分比例": 0.2538},
    {"戶號": "D2-12F", "區分比例": 0.2538},
    {"戶號": "D2-13F", "區分比例": 0.2538},
    {"戶號": "D1-2F", "區分比例": 0.2538},
    {"戶號": "D1-3F", "區分比例": 0.2595},
    {"戶號": "D1-4F", "區分比例": 0.2586},
    {"戶號": "D1-5F", "區分比例": 0.2586},
    {"戶號": "D1-6F", "區分比例": 0.2586},
    {"戶號": "D1-7F", "區分比例": 0.2586},
    {"戶號": "D1-8F", "區分比例": 0.2586},
    {"戶號": "D1-9F", "區分比例": 0.2586},
    {"戶號": "D1-10F", "區分比例": 0.2586},
    {"戶號": "D1-11F", "區分比例": 0.2586},
    {"戶號": "D1-12F", "區分比例": 0.2586},
    {"戶號": "D1-13F", "區分比例": 0.2586},
    {"戶號": "B1-1F", "區分比例": 0.2586},
    {"戶號": "A5-1F", "區分比例": 0.2467},
    {"戶號": "B2-1F", "區分比例": 0.2497},
    {"戶號": "A3-1F", "區分比例": 0.2489},
    {"戶號": "A2-1F", "區分比例": 0.2543},
    {"戶號": "J2-1F", "區分比例": 0.272},
    {"戶號": "I2-1F", "區分比例": 0.2596},
    {"戶號": "I1-1F", "區分比例": 0.2608},
    {"戶號": "H2-1F", "區分比例": 0.2935},
    {"戶號": "H1-1F", "區分比例": 0.3192},
    {"戶號": "G2-1F", "區分比例": 0.2598},
    {"戶號": "G1-1F", "區分比例": 0.2249},
    {"戶號": "F3-1F", "區分比例": 0.2506},
    {"戶號": "F2-1F", "區分比例": 0.2706},
    {"戶號": "E3-1F", "區分比例": 0.2542},
    {"戶號": "E2-1F", "區分比例": 0.2489},
    {"戶號": "E1-1F", "區分比例": 0.257},
    {"戶號": "D5-1F", "區分比例": 0.2467},
    {"戶號": "D3-1F", "區分比例": 0.2456},
    {"戶號": "S9", "區分比例": 0.126},
    {"戶號": "S8", "區分比例": 0.115},
    {"戶號": "S7", "區分比例": 0.1346},
    {"戶號": "S6", "區分比例": 0.1794},
    {"戶號": "S5", "區分比例": 0.1859},
    {"戶號": "S3", "區分比例": 0.1346},
    {"戶號": "S2", "區分比例": 0.115},
    {"戶號": "S1", "區分比例": 0.126},
]

# 將字典列表轉換為 DataFrame
try:
    st.session_state.data = pd.DataFrame(RAW_DATA).set_index('戶號')
except Exception as e:
    st.session_state.data = None

# 檢查 URL 參數以判斷是否有戶號資訊
query_params = st.query_params
household_id_from_url = query_params.get("戶號")

if household_id_from_url:
    if st.session_state.data is None:
        st.error("名冊資料載入失敗，請檢查程式碼。")
    else:
        if household_id_from_url in st.session_state.data.index:
            household_id = household_id_from_url
            st.info(f"歡迎戶號 **{household_id}**！")

            st.subheader("請對以下所有議題進行投票：")

            voted_issues_count = 0
            for i, issue in enumerate(ISSUES):
                st.markdown(f"**{issue}**")

                # 從外部檔案讀取投票結果以檢查是否已投票
                try:
                    df_vote = pd.read_csv(f"https://raw.githubusercontent.com/acidcocco/community-voting-app/main/vote_results_{i}.csv", dtype={"戶號": str})
                    if household_id in df_vote['戶號'].values:
                        st.success("您已完成此議題的投票。")
                        voted_issues_count += 1
                    else:
                        vote_option = st.radio("您的選擇：", ('同意', '不同意'), key=f"radio_{i}")
                        if st.button(f"確認對「議題 {i+1}」投票", key=f"button_{i}"):
                            voter_data = st.session_state.data.loc[household_id]
                            new_vote = pd.DataFrame([{
                                '戶號': household_id,
                                '區分比例': voter_data['區分比例'],
                                '投票': vote_option
                            }])
                            if f'temp_vote_{i}' not in st.session_state:
                                st.session_state[f'temp_vote_{i}'] = pd.DataFrame(columns=['戶號', '區分比例', '投票'])
                            st.session_state[f'temp_vote_{i}'] = pd.concat(
                                [st.session_state[f'temp_vote_{i}'], new_vote],
                                ignore_index=True
                            )
                            st.success(f"投票成功！感謝您的參與。")
                            st.rerun()
                except Exception:
                    # 檔案不存在，表示尚未有投票紀錄
                    vote_option = st.radio("您的選擇：", ('同意', '不同意'), key=f"radio_{i}")
                    if st.button(f"確認對「議題 {i+1}」投票", key=f"button_{i}"):
                        voter_data = st.session_state.data.loc[household_id]
                        new_vote = pd.DataFrame([{
                            '戶號': household_id,
                            '區分比例': voter_data['區分比例'],
                            '投票': vote_option
                        }])
                        if f'temp_vote_{i}' not in st.session_state:
                            st.session_state[f'temp_vote_{i}'] = pd.DataFrame(columns=['戶號', '區分比例', '投票'])
                        st.session_state[f'temp_vote_{i}'] = pd.concat(
                            [st.session_state[f'temp_vote_{i}'], new_vote],
                            ignore_index=True
                        )
                        st.success(f"投票成功！感謝您的參與。")
                        st.rerun()
            
            if voted_issues_count == len(ISSUES):
                st.success("您已完成所有議題的投票！")
        else:
            st.error("您掃描的 QR Code 無效。請確認您使用的是正確的投票連結。")
else:
    st.warning("請掃描您的專屬 QR Code 以進行投票。")

# ================================
# 管理者專區
# ================================
st.sidebar.header("管理者專區")
st.sidebar.markdown("名冊資料已內嵌在程式碼中。")

if 'data' in st.session_state and st.session_state.data is not None:
    st.sidebar.divider()
    st.sidebar.subheader("QR Code 產生器")
    
    # 批次產生 QR Code
    st.sidebar.markdown("##### 批次產生所有戶號的 QR Code")
    if st.sidebar.button("產生所有 QR Code 壓縮檔"):
        zip_buffer = io.BytesIO()
        with zipfile.ZipFile(zip_buffer, 'w', zipfile.ZIP_DEFLATED) as zipf:
            for household_id in st.session_state.data.index.tolist():
                params = {'戶號': household_id}
                full_url = f"{APP_URL}?{urlencode(params)}"
                img = generate_qr_with_label(full_url, f"戶號: {household_id}")

                img_buffer = io.BytesIO()
                img.save(img_buffer, format="PNG")
                img_buffer.seek(0)
                zipf.writestr(f"{household_id}_qrcode.png", img_buffer.read())

        st.sidebar.download_button(
            label="下載 QR Code 壓縮檔",
            data=zip_buffer.getvalue(),
            file_name="all_qrcodes.zip",
            mime="application/zip"
        )
        st.sidebar.success("QR Code 壓縮檔已產生！")
    
    # 單一產生 QR Code
    st.sidebar.markdown("---")
    st.sidebar.markdown("##### 單一產生 QR Code")
    household_for_qr = st.sidebar.selectbox(
        "請選擇要產生 QR Code 的戶號：",
        options=['請選擇'] + st.session_state.data.index.tolist()
    )

    if household_for_qr != '請選擇':
        params = {'戶號': household_for_qr}
        full_url = f"{APP_URL}?{urlencode(params)}"
        img = generate_qr_with_label(full_url, f"戶號: {household_for_qr}")
        buf = io.BytesIO()
        img.save(buf, format="PNG")
        st.sidebar.markdown(f"#### 戶號: {household_for_qr}")
        st.sidebar.image(img, caption="請掃描此 QR Code 進行投票")
        st.sidebar.download_button(
            label="下載 QR Code 圖片",
            data=buf.getvalue(),
            file_name=f"{household_for_qr}_qrcode.png",
            mime="image/png"
        )
else:
    st.sidebar.warning("名冊資料載入失敗，QR Code 產生器無法使用。")

# ================================
# 投票即時報表
# ================================
st.divider()
st.header("投票即時報表")

if 'data' in st.session_state and st.session_state.data is not None:
    for i, issue in enumerate(ISSUES):
        st.subheader(f"📊 {issue}")
        vote_results = st.session_state[f'vote_results_{i}']
        if not vote_results.empty:
            total_votes = len(vote_results)
            st.info(f"目前總投票人數：{total_votes}")
            
            agree_votes = vote_results[vote_results['投票'] == '同意']
            disagree_votes = vote_results[vote_results['投票'] == '不同意']
            
            agree_count = len(agree_votes)
            disagree_count = len(disagree_votes)
            
            agree_ratio = agree_votes['區分比例'].sum()
            disagree_ratio = disagree_votes['區分比例'].sum()
            
            col1, col2 = st.columns(2)
            with col1:
                st.metric(label="同意票數", value=agree_count, delta=f"{agree_ratio:.4f}")
                st.write("區分比例：", f"{agree_ratio:.4f}")
            with col2:
                st.metric(label="不同意票數", value=disagree_count, delta=f"{disagree_ratio:.4f}")
                st.write("區分比例：", f"{disagree_ratio:.4f}")
            
            st.write("已投票清單：")
            st.dataframe(vote_results[['戶號', '區分比例', '投票']])
        else:
            st.info("尚無投票記錄。")
        st.write("---")
else:
    st.info("名冊資料載入失敗，無法顯示報表。")
